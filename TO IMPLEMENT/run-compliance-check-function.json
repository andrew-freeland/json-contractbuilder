{
  "name": "CSLB Compliance Check Workflow",
  "nodes": [
    {
      "name": "CSLB Compliance Check",
      "type": "n8n-nodes-base.function",
      "parameters": {
        "functionCode": "// Function Node: CSLB Compliance Checker\n// Input: $json.contractData (extracted project data)\n// Output: Compliance status, warnings, and recommendations\n\nconst contractData = $json.contractData || $json;\nconst callSid = contractData.callSid;\n\n// CSLB ¬ß7159 Home Improvement Contract Requirements\nconst cslbRequirements = {\n  // Required contract elements\n  requiredElements: {\n    contractorInfo: {\n      name: 'Contractor Information',\n      required: true,\n      fields: ['contractorName', 'contractorAddress', 'licenseNumber', 'phoneNumber']\n    },\n    clientInfo: {\n      name: 'Client Information', \n      required: true,\n      fields: ['clientName', 'clientAddress', 'phoneNumber']\n    },\n    projectDetails: {\n      name: 'Project Details',\n      required: true,\n      fields: ['projectAddress', 'scopeOfWork', 'projectType']\n    },\n    financialTerms: {\n      name: 'Financial Terms',\n      required: true,\n      fields: ['contractPrice', 'paymentTerms', 'paymentSchedule']\n    },\n    timeline: {\n      name: 'Project Timeline',\n      required: true,\n      fields: ['startDate', 'completionDate']\n    },\n    materials: {\n      name: 'Materials Information',\n      required: true,\n      fields: ['materialsProvidedBy', 'materialsDescription']\n    },\n    permits: {\n      name: 'Permits and Licenses',\n      required: true,\n      fields: ['permitsRequired', 'whoObtainsPermits']\n    },\n    warranties: {\n      name: 'Warranties',\n      required: true,\n      fields: ['warrantyPeriod', 'warrantyCoverage']\n    }\n  },\n  \n  // Payment structure requirements\n  paymentRequirements: {\n    maxUpfront: 0.10, // Maximum 10% upfront for contracts > $1,000\n    progressPayments: true,\n    finalPayment: 'upon completion and acceptance',\n    lienRights: true\n  },\n  \n  // Prohibited terms\n  prohibitedTerms: [\n    'waiver of lien rights',\n    'unconditional lien waiver',\n    'pay when paid clauses',\n    'no damages for delay',\n    'unlimited indemnification'\n  ]\n};\n\n// Validation functions\nconst validators = {\n  // Check if all required fields are present\n  checkRequiredFields: (data) => {\n    const missing = [];\n    const warnings = [];\n    \n    Object.entries(cslbRequirements.requiredElements).forEach(([key, requirement]) => {\n      const hasRequiredFields = requirement.fields.some(field => data[field]);\n      \n      if (requirement.required && !hasRequiredFields) {\n        missing.push(requirement.name);\n      } else if (requirement.required && hasRequiredFields) {\n        // Check for partial completion\n        const completedFields = requirement.fields.filter(field => data[field]);\n        if (completedFields.length < requirement.fields.length) {\n          warnings.push(`‚ö†Ô∏è ${requirement.name}: Incomplete (${completedFields.length}/${requirement.fields.length} fields)`);\n        }\n      }\n    });\n    \n    return { missing, warnings };\n  },\n  \n  // Validate payment structure\n  validatePaymentStructure: (paymentTerms) => {\n    const warnings = [];\n    \n    if (!paymentTerms) return warnings;\n    \n    const terms = paymentTerms.toLowerCase();\n    \n    // Check for excessive upfront payment\n    const upfrontMatch = terms.match(/(\\d+)%\\s*upfront/);\n    if (upfrontMatch) {\n      const upfrontPercent = parseInt(upfrontMatch[1]);\n      if (upfrontPercent > 10) {\n        warnings.push(`‚ö†Ô∏è Upfront payment (${upfrontPercent}%) exceeds CSLB maximum (10%)`);\n      }\n    }\n    \n    // Check for prohibited terms\n    cslbRequirements.prohibitedTerms.forEach(term => {\n      if (terms.includes(term)) {\n        warnings.push(`üö´ Prohibited term detected: \"${term}\"`);\n      }\n    });\n    \n    // Check for progress payments\n    if (!terms.includes('progress') && !terms.includes('milestone') && !terms.includes('completion')) {\n      warnings.push('‚ö†Ô∏è Payment structure should include progress payments or completion-based terms');\n    }\n    \n    return warnings;\n  },\n  \n  // Validate project scope\n  validateProjectScope: (scope, projectType) => {\n    const warnings = [];\n    \n    if (!scope || scope.length < 10) {\n      warnings.push('‚ö†Ô∏è Project scope is too brief - CSLB requires detailed description');\n    }\n    \n    if (projectType && scope) {\n      // Check for scope-type alignment\n      const scopeLower = scope.toLowerCase();\n      const typeLower = projectType.toLowerCase();\n      \n      if (!scopeLower.includes(typeLower) && !scopeLower.includes('renovation') && !scopeLower.includes('construction')) {\n        warnings.push('‚ö†Ô∏è Project scope should clearly describe the type of work');\n      }\n    }\n    \n    return warnings;\n  },\n  \n  // Validate timeline\n  validateTimeline: (startDate, endDate) => {\n    const warnings = [];\n    \n    if (!startDate) {\n      warnings.push('‚ö†Ô∏è Start date is required for CSLB compliance');\n    }\n    \n    if (!endDate) {\n      warnings.push('‚ö†Ô∏è Completion date should be specified');\n    } else if (startDate && endDate) {\n      // Check if end date is after start date\n      const start = new Date(startDate);\n      const end = new Date(endDate);\n      \n      if (end <= start) {\n        warnings.push('‚ö†Ô∏è Completion date should be after start date');\n      }\n    }\n    \n    return warnings;\n  },\n  \n  // Validate license information\n  validateLicense: (licenseNumber, contractorName) => {\n    const warnings = [];\n    \n    if (!licenseNumber && contractorName) {\n      warnings.push('‚ö†Ô∏è Contractor license number is required for CSLB compliance');\n    }\n    \n    if (licenseNumber) {\n      // Basic CA license format validation\n      const caLicensePattern = /^[A-Z]\\d{8}$/;\n      if (!caLicensePattern.test(licenseNumber)) {\n        warnings.push('‚ö†Ô∏è License number format appears invalid (should be A12345678)');\n      }\n    }\n    \n    return warnings;\n  }\n};\n\n// Main compliance check function\nconst runComplianceCheck = () => {\n  const startTime = Date.now();\n  \n  try {\n    // Run all validations\n    const requiredCheck = validators.checkRequiredFields(contractData);\n    const paymentWarnings = validators.validatePaymentStructure(contractData.paymentTerms);\n    const scopeWarnings = validators.validateProjectScope(contractData.scopeOfWork, contractData.projectType);\n    const timelineWarnings = validators.validateTimeline(contractData.startDate, contractData.endDate);\n    const licenseWarnings = validators.validateLicense(contractData.licenseNumber, contractData.contractorName);\n    \n    // Combine all warnings\n    const allWarnings = [\n      ...requiredCheck.warnings,\n      ...paymentWarnings,\n      ...scopeWarnings,\n      ...timelineWarnings,\n      ...licenseWarnings\n    ];\n    \n    // Determine compliance status\n    const isCompliant = requiredCheck.missing.length === 0 && allWarnings.length === 0;\n    const needsReview = requiredCheck.missing.length === 0 && allWarnings.length > 0;\n    const nonCompliant = requiredCheck.missing.length > 0;\n    \n    let complianceStatus;\n    if (isCompliant) {\n      complianceStatus = 'COMPLIANT';\n    } else if (needsReview) {\n      complianceStatus = 'REVIEW_REQUIRED';\n    } else {\n      complianceStatus = 'NON_COMPLIANT';\n    }\n    \n    // Generate recommendations\n    const recommendations = [];\n    \n    if (requiredCheck.missing.length > 0) {\n      recommendations.push(`Add missing required elements: ${requiredCheck.missing.join(', ')}`);\n    }\n    \n    if (allWarnings.length > 0) {\n      recommendations.push('Review and address compliance warnings');\n    }\n    \n    if (!contractData.licenseNumber) {\n      recommendations.push('Include contractor license number');\n    }\n    \n    if (!contractData.endDate) {\n      recommendations.push('Specify project completion date');\n    }\n    \n    // Calculate compliance score (0-100)\n    const totalChecks = Object.keys(cslbRequirements.requiredElements).length + 4; // +4 for additional validations\n    const passedChecks = totalChecks - requiredCheck.missing.length - (allWarnings.length * 0.5);\n    const complianceScore = Math.max(0, Math.min(100, Math.round((passedChecks / totalChecks) * 100)));\n    \n    const processingTime = Date.now() - startTime;\n    \n    return {\n      complianceStatus,\n      complianceScore,\n      isCompliant,\n      needsReview,\n      nonCompliant,\n      missingElements: requiredCheck.missing,\n      warnings: allWarnings,\n      recommendations,\n      processingTime: `${processingTime}ms`,\n      timestamp: new Date().toISOString(),\n      callSid: callSid,\n      \n      // Detailed breakdown\n      validationResults: {\n        requiredElements: requiredCheck,\n        paymentStructure: paymentWarnings,\n        projectScope: scopeWarnings,\n        timeline: timelineWarnings,\n        license: licenseWarnings\n      },\n      \n      // CSLB reference\n      cslbReference: {\n        section: '¬ß7159',\n        title: 'Home Improvement Contracts',\n        url: 'https://www.leginfo.legislature.ca.gov/faces/codes_displaySection.xhtml?sectionNum=7159.&lawCode=BPC'\n      }\n    };\n    \n  } catch (error) {\n    console.error('Error in compliance check:', error);\n    return {\n      complianceStatus: 'ERROR',\n      error: 'COMPLIANCE_CHECK_FAILED',\n      message: error.message,\n      timestamp: new Date().toISOString(),\n      callSid: callSid\n    };\n  }\n};\n\n// Execute compliance check\nreturn runComplianceCheck();"
      },
      "typeVersion": 1,
      "position": [500, 300],
      "id": "run-compliance-check-function"
    }
  ],
  "connections": {},
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "cslb-compliance-check-workflow",
  "tags": [
    {
      "createdAt": "2025-01-27T10:00:00.000Z",
      "updatedAt": "2025-01-27T10:00:00.000Z",
      "id": "compliance-check",
      "name": "Compliance Check"
    }
  ]
} 